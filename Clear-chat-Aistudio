// ==UserScript==
// @name         Google AI Studio | Clear Chat (Keep First 3 Messages)
// @namespace    https://greasyfork.org/en/users/1462137-piknockyou
// @version      2.5
// @author       Nguyễn Ngọc Tuyên
// @license      AGPL-3.0
// @description  Xóa tất cả chat nhưng giữ lại 3 dòng đầu tiên. Sử dụng SVG để fix lỗi hiển thị icon.
// @match        https://aistudio.google.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=aistudio.google.com
// @grant        GM_addStyle
// @run-at       document-idle
// @downloadURL https://raw.githubusercontent.com/Hetboy95/Be-Vietnam-Pro-font-script/refs/heads/main/Clear-chat-Aistudio
// @updateURL https://raw.githubusercontent.com/Hetboy95/Be-Vietnam-Pro-font-script/refs/heads/main/Clear-chat-Aistudio
// ==/UserScript==

(function() {
    'use strict';

    if (window.self !== window.top) return;

    const MESSAGES_TO_KEEP = 3;

    // Selector mới nhất
    const CHAT_TURN_OPTIONS_SELECTOR = 'ms-chat-turn-options button';
    const DELETE_BUTTON_MENU_SELECTOR = 'button[role="menuitem"], .mat-mdc-menu-item';

    // CSS để nút trông giống hệt nút của Google
    GM_addStyle(`
        #gemini-cleaner-button {
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: #d93025; /* Màu đỏ Google */
            transition: background 0.2s;
            margin: 0 4px;
            padding: 6px;
            border: none;
            background: transparent;
        }
        #gemini-cleaner-button:hover {
            background-color: rgba(217, 48, 37, 0.08);
        }
        #gemini-cleaner-button svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }
        .gcc-tooltip {
            position: fixed; background: #3c4043; border-radius: 4px;
            padding: 5px 10px; font-family: Roboto, Arial, sans-serif; font-size: 11px;
            color: #fff; z-index: 20000; pointer-events: none; opacity: 0;
            transition: opacity 0.2s; white-space: nowrap;
        }
        .gcc-tooltip.visible { opacity: 1; }
    `);

    let gccTooltip = null;

    function showTooltip(btn, text) {
        if (!gccTooltip) {
            gccTooltip = document.createElement('div');
            gccTooltip.className = 'gcc-tooltip';
            document.body.appendChild(gccTooltip);
        }
        gccTooltip.textContent = text;
        const rect = btn.getBoundingClientRect();
        gccTooltip.style.left = `${rect.left + rect.width / 2 - gccTooltip.offsetWidth / 2}px`;
        gccTooltip.style.top = `${rect.bottom + 8}px`;
        gccTooltip.classList.add('visible');
    }

    function hideTooltip() {
        if (gccTooltip) gccTooltip.classList.remove('visible');
    }

    async function deleteMessagesSequentially() {
        const elements = document.querySelectorAll(CHAT_TURN_OPTIONS_SELECTOR);
        if (elements.length <= MESSAGES_TO_KEEP) {
            alert(`Chỉ còn ${elements.length} tin nhắn, không cần xóa.`);
            return;
        }

        if (!confirm(`Xóa ${elements.length - MESSAGES_TO_KEEP} tin nhắn và GIỮ LẠI ${MESSAGES_TO_KEEP} câu đầu?`)) {
            return;
        }

        for (let i = elements.length - 1; i >= MESSAGES_TO_KEEP; i--) {
            try {
                // Lấy lại danh sách mỗi lần lặp vì DOM thay đổi khi xóa
                const currentElements = document.querySelectorAll(CHAT_TURN_OPTIONS_SELECTOR);
                if (!currentElements[i]) continue;

                currentElements[i].scrollIntoView({ block: 'center' });
                currentElements[i].click();

                await new Promise(r => setTimeout(r, 250));

                const menuButtons = document.querySelectorAll(DELETE_BUTTON_MENU_SELECTOR);
                for (let btn of menuButtons) {
                    if (btn.innerText.includes('Delete')) {
                        btn.click();
                        break;
                    }
                }
                await new Promise(r => setTimeout(r, 400));
            } catch (err) {
                console.error('Lỗi tại vị trí ' + i, err);
            }
        }
    }

    function createToolbarButton() {
        // Tìm thanh công cụ bên phải (chỗ có các icon Get Code, Share...)
        const toolbar = document.querySelector('.header-actions-container') ||
                        document.querySelector('ms-toolbar .toolbar-right') ||
                        document.querySelector('.top-nav-actions');

        if (!toolbar || document.getElementById('gemini-cleaner-button')) return;

        const button = document.createElement('button');
        button.id = 'gemini-cleaner-button';
        button.type = 'button';
        button.title = ''; // Để dùng tooltip tự chế

        // Sử dụng SVG thay cho Icon Font để tránh lỗi hiển thị chữ
        button.innerHTML = `
            <svg viewBox="0 0 24 24">
                <path d="M15,16h4v2h-4V16z M15,8h7v2h-7V8z M15,12h6v2h-6V12z M3,18c0,1.1,0.9,2,2,2h6c1.1,0,2-0.9,2-2V8H3V18z M14,5h-3l-1-1H6L5,5H2v2h12V5z"/>
            </svg>
        `;

        button.onclick = (e) => {
            e.preventDefault();
            deleteMessagesSequentially();
        };

        button.onmouseenter = () => showTooltip(button, `Xóa nhanh (Giữ ${MESSAGES_TO_KEEP} câu đầu)`);
        button.onmouseleave = hideTooltip;

        // Chèn vào đầu thanh công cụ
        toolbar.prepend(button);
    }

    // Observer để theo dõi khi nào trang load xong các thành phần UI
    const observer = new MutationObserver(() => {
        createToolbarButton();
    });

    observer.observe(document.body, { childList: true, subtree: true });

    // Thử tạo ngay
    setTimeout(createToolbarButton, 1500);
})();
