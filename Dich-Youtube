// ==UserScript==
// @name         YouTube Translate Button (Text: Dá»‹ch comment)
// @namespace    http://tampermonkey.net/
// @version      13.2
// @description  Tá»± Ä‘á»™ng dá»‹ch bÃ¬nh luáº­n (Shorts & Video). NÃºt hiá»ƒn thá»‹ "Dá»‹ch comment".
// @author       Nguyá»…n Ngá»c TuyÃªn
// @match        https://www.youtube.com/*
// @match        https://m.youtube.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- Cáº¤U HÃŒNH ---
    const COMMENT_HEADER_KEYWORDS = ["BÃ¬nh luáº­n", "Comments", "bÃ¬nh luáº­n", "comments", "TiÃªu Ä‘á»", "Transcript"];
    
    const TRANSLATE_TEXTS = ["dá»‹ch sang tiáº¿ng viá»‡t", "translate to vietnamese", "ë² íŠ¸ë‚¨ì–´ë¡œ ë²ˆì—­"];
    const ORIGINAL_TEXTS = ["xem báº£n gá»‘c", "xem vÄƒn báº£n gá»‘c", "see original", "see translation", "nguyÃªn vÄƒn", "báº£n dá»‹ch tá»± Ä‘á»™ng"];

    const ID_BTN_PREFIX = "yt-trans-btn-"; 
    const BUTTON_LABEL = "Dá»‹ch comment"; // Ná»™i dung nÃºt hiá»ƒn thá»‹

    let isAutoTranslating = false;

    // --- STYLE NÃšT ---
    const btnStyle = {
        display: "inline-flex",
        alignItems: "center",
        justifyContent: "center",
        height: "32px",
        padding: "0 14px", // TÄƒng padding má»™t chÃºt cho chá»¯ dÃ i hÆ¡n
        backgroundColor: "transparent",
        color: "#0f0f0f",
        border: "1px solid #ccc",
        borderRadius: "18px",
        cursor: "pointer",
        fontWeight: "500",
        fontSize: "13px",
        fontFamily: "Roboto, Arial, sans-serif",
        whiteSpace: "nowrap",
        marginRight: "8px",
        zIndex: "9999"
    };

    // --- HÃ€M Táº O NÃšT ---
    function createButton(uniqueId) {
        const btn = document.createElement("button");
        btn.id = uniqueId;
        btn.textContent = BUTTON_LABEL; // Sá»­ dá»¥ng nhÃ£n "Dá»‹ch comment"
        btn.title = "Báº­t/Táº¯t tá»± Ä‘á»™ng dá»‹ch Comment";
        
        Object.assign(btn.style, btnStyle);

        if (document.querySelector("html[dark]")) {
            btn.style.color = "#fff";
            btn.style.borderColor = "#666";
        }

        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleTranslationMode();
        };

        return btn;
    }

    // --- Cáº¬P NHáº¬T GIAO DIá»†N ---
    function updateVisuals() {
        const buttons = document.querySelectorAll(`button[id^="${ID_BTN_PREFIX}"]`);
        const isDark = document.querySelector("html[dark]");

        buttons.forEach(btn => {
            if (isAutoTranslating) {
                btn.textContent = "Äang Dá»‹ch ðŸŸ¢";
                btn.style.borderColor = "#065fd4";
                btn.style.color = "#065fd4";
                btn.style.backgroundColor = isDark ? "rgba(6, 95, 212, 0.2)" : "rgba(6, 95, 212, 0.1)";
            } else {
                btn.textContent = BUTTON_LABEL; // Tráº£ vá» "Dá»‹ch comment" khi táº¯t
                btn.style.borderColor = isDark ? "#666" : "#ccc";
                btn.style.color = isDark ? "#fff" : "#0f0f0f";
                btn.style.backgroundColor = "transparent";
            }
        });
    }

    // --- LOGIC CLICK ---
    function clickAllButtons(keywords) {
        const keywordConditions = keywords.map(k => `contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${k}')`).join(' or ');
        const xpath = `//*[${keywordConditions}]`;
        const result = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);

        for (let i = 0; i < result.snapshotLength; i++) {
            let element = result.snapshotItem(i);
            if (element.offsetParent === null) continue;
            
            element.click();
            
            let parent = element.parentElement;
            let attempts = 0;
            while (parent && attempts < 2) {
                if (parent.tagName === 'BUTTON' || parent.getAttribute('role') === 'button') {
                    parent.click();
                    break;
                }
                parent = parent.parentElement;
                attempts++;
            }
        }
    }

    function toggleTranslationMode() {
        isAutoTranslating = !isAutoTranslating;
        updateVisuals();
        if (isAutoTranslating) clickAllButtons(TRANSLATE_TEXTS);
        else clickAllButtons(ORIGINAL_TEXTS);
    }

    // --- SCANNER ---
    function scanAndInject() {
        // 1. Shorts
        const headers = document.querySelectorAll('ytd-engagement-panel-title-header-renderer');
        headers.forEach((header, index) => {
            if (header.offsetParent === null) return; 

            const headerText = header.innerText || "";
            const isCommentSection = COMMENT_HEADER_KEYWORDS.some(kw => headerText.includes(kw));

            if (isCommentSection) {
                const endContainer = header.querySelector('#end') || header.querySelector('#menu');
                if (endContainer) {
                    const btnId = `${ID_BTN_PREFIX}shorts-${index}`;
                    if (!endContainer.querySelector(`#${btnId}`)) {
                        const btn = createButton(btnId);
                        endContainer.prepend(btn);
                        endContainer.style.display = "flex";
                        endContainer.style.alignItems = "center";
                        updateVisuals();
                    }
                }
            }
        });
        
        // 2. Video thÆ°á»ng
        if (window.location.href.includes("/watch") && !window.location.href.includes("/shorts")) {
             const sortMenu = document.querySelector("ytd-comments-header-renderer #sort-menu");
             if (sortMenu && sortMenu.parentNode && !document.getElementById(`${ID_BTN_PREFIX}normal`)) {
                 const btn = createButton(`${ID_BTN_PREFIX}normal`);
                 sortMenu.parentNode.insertBefore(btn, sortMenu.nextSibling);
                 updateVisuals();
             }
        }
        
        // 3. Masthead
        const masthead = document.querySelector("ytd-masthead #start");
        const mastheadBtnId = `${ID_BTN_PREFIX}masthead`;
        if (masthead && !document.getElementById(mastheadBtnId)) {
             const btn = createButton(mastheadBtnId);
             btn.style.marginLeft = "20px";
             masthead.appendChild(btn);
        }
        
        const mastheadBtn = document.getElementById(mastheadBtnId);
        if (mastheadBtn) {
            const isViewing = window.location.href.includes("/watch") || window.location.href.includes("/shorts");
            mastheadBtn.style.display = isViewing ? "inline-flex" : "none";
        }
    }

    // --- LOOP ---
    setInterval(() => {
        scanAndInject();
        if (isAutoTranslating) {
            clickAllButtons(TRANSLATE_TEXTS);
        }
    }, 1000);

})();
