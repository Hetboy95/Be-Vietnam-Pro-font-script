// ==UserScript==
// @name         YouTube Translate Button V10 (Smart Hide on Home)
// @namespace    http://tampermonkey.net/
// @version      10.1
// @description  N√∫t D·ªãch c·∫°nh Logo ch·ªâ hi·ªán khi xem Video. N√∫t d∆∞·ªõi Comment gi·ªØ nguy√™n.
// @author       Nguy·ªÖn Ng·ªçc Tuy√™n
// @match        https://www.youtube.com/*
// @match        https://m.youtube.com/*
// @grant        none
// @downloadURL https://raw.githubusercontent.com/Hetboy95/Be-Vietnam-Pro-font-script/refs/heads/main/Dich-Youtube
// @updateURL https://raw.githubusercontent.com/Hetboy95/Be-Vietnam-Pro-font-script/refs/heads/main/Dich-Youtube
// ==/UserScript==

(function() {
    'use strict';

    // --- C·∫§U H√åNH ---
    const TRANSLATE_TEXTS = ["d·ªãch sang ti·∫øng vi·ªát", "translate to vietnamese", "Î≤†Ìä∏ÎÇ®Ïñ¥Î°ú Î≤àÏó≠"];
    const ORIGINAL_TEXTS = ["xem b·∫£n g·ªëc", "xem vƒÉn b·∫£n g·ªëc", "see original", "see translation", "nguy√™n vƒÉn", "b·∫£n d·ªãch t·ª± ƒë·ªông"];

    const ID_HEADER_BTN = "yt-header-translate-btn";
    const ID_COMMENT_BTN = "yt-comment-translate-btn";

    let isAutoTranslating = false;

    // --- H√ÄM T·∫†O N√öT ---
    function createButton(id, defaultText) {
        if (document.getElementById(id)) return null;

        const btn = document.createElement("button");
        btn.id = id;
        btn.textContent = defaultText;
        btn.title = "B·∫≠t/T·∫Øt t·ª± ƒë·ªông d·ªãch Comment";

        Object.assign(btn.style, {
            display: "inline-flex", // M·∫∑c ƒë·ªãnh l√† hi·ªán
            alignItems: "center",
            justifyContent: "center",
            height: "32px",
            padding: "0 14px",
            backgroundColor: "transparent",
            color: "#0f0f0f",
            border: "1px solid #ccc",
            borderRadius: "18px",
            cursor: "pointer",
            fontWeight: "500",
            fontSize: "13px",
            fontFamily: "Roboto, Arial, sans-serif",
            transition: "all 0.2s",
            whiteSpace: "nowrap"
        });

        if (id === ID_HEADER_BTN) {
            btn.style.marginLeft = "20px";
            btn.style.height = "30px";
        } else {
            btn.style.marginLeft = "10px";
        }

        if (document.querySelector("html[dark]")) {
            btn.style.color = "#fff";
            btn.style.borderColor = "#555";
        }

        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleTranslationMode();
        };

        return btn;
    }

    // --- C·∫¨P NH·∫¨T M√ÄU S·∫ÆC N√öT ---
    function updateButtonsVisual() {
        const buttons = [document.getElementById(ID_HEADER_BTN), document.getElementById(ID_COMMENT_BTN)];
        const isDark = document.querySelector("html[dark]");

        buttons.forEach(btn => {
            if (!btn) return;
            if (isAutoTranslating) {
                btn.textContent = "ƒêang T·ª± ƒê·ªông D·ªãch üü¢";
                btn.style.borderColor = "#065fd4";
                btn.style.color = "#065fd4";
                btn.style.backgroundColor = isDark ? "rgba(6, 95, 212, 0.2)" : "rgba(6, 95, 212, 0.1)";
            } else {
                btn.textContent = "üáªüá≥ D·ªãch Comment";
                btn.style.borderColor = isDark ? "#555" : "#ccc";
                btn.style.color = isDark ? "#fff" : "#0f0f0f";
                btn.style.backgroundColor = "transparent";
            }
        });
    }

    // --- H√ÄM CLICK (LOGIC CH√çNH) ---
    function clickAllButtons(keywords) {
        const keywordConditions = keywords.map(k => `contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${k}')`).join(' or ');
        const xpath = `//*[${keywordConditions}]`;
        const result = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);

        for (let i = 0; i < result.snapshotLength; i++) {
            let element = result.snapshotItem(i);
            if (element.offsetParent === null) continue;

            element.click();
            let parent = element.parentElement;
            let attempts = 0;
            while (parent && attempts < 3) {
                if (parent.tagName === 'BUTTON' || parent.tagName === 'A' || parent.getAttribute('role') === 'button') {
                    parent.click();
                    break;
                }
                parent = parent.parentElement;
                attempts++;
            }
        }
    }

    function toggleTranslationMode() {
        isAutoTranslating = !isAutoTranslating;
        updateButtonsVisual();
        if (isAutoTranslating) clickAllButtons(TRANSLATE_TEXTS);
        else clickAllButtons(ORIGINAL_TEXTS);
    }

    // --- QU·∫¢N L√ù GIAO DI·ªÜN (PH·∫¶N QUAN TR·ªåNG ƒê√É S·ª¨A) ---
    function manageInterface() {
        // 1. Ki·ªÉm tra xem c√≥ ƒëang ·ªü trang xem video kh√¥ng?
        // URL ph·∫£i ch·ª©a "/watch" ho·∫∑c "/shorts" (n·∫øu b·∫°n mu·ªën h·ªó tr·ª£ c·∫£ Shorts)
        const isWatchPage = window.location.href.includes("/watch") || window.location.href.includes("/shorts");

        // --- X·ª¨ L√ù N√öT HEADER ---
        const headerStart = document.querySelector("ytd-masthead #start");
        let headerBtn = document.getElementById(ID_HEADER_BTN);

        if (headerStart && !headerBtn) {
            // N·∫øu ch∆∞a c√≥ n√∫t th√¨ t·∫°o
            headerBtn = createButton(ID_HEADER_BTN, "üáªüá≥ D·ªãch Comment");
            headerStart.appendChild(headerBtn);
        }

        if (headerBtn) {
            // LOGIC ·∫®N/HI·ªÜN: N·∫øu ƒëang xem video th√¨ hi·ªán (inline-flex), ng∆∞·ª£c l·∫°i th√¨ ·∫©n (none)
            headerBtn.style.display = isWatchPage ? "inline-flex" : "none";
        }

        // --- X·ª¨ L√ù N√öT COMMENT (Ch·ªâ hi·ªán khi c√≥ khung comment) ---
        const sortMenu = document.querySelector("ytd-comments-header-renderer #sort-menu");
        const titleContainer = document.querySelector("ytd-comments-header-renderer #title");

        if ((sortMenu || titleContainer) && !document.getElementById(ID_COMMENT_BTN)) {
            const btn = createButton(ID_COMMENT_BTN, "üáªüá≥ D·ªãch Comment");
            if (sortMenu && sortMenu.parentNode) {
                sortMenu.parentNode.insertBefore(btn, sortMenu.nextSibling);
            } else if (titleContainer) {
                titleContainer.appendChild(btn);
            }
            updateButtonsVisual(); // ƒê·ªìng b·ªô tr·∫°ng th√°i ngay
        }
    }

    // --- LOOP ---
    setInterval(() => {
        manageInterface(); // Ki·ªÉm tra URL v√† v·∫Ω n√∫t
        if (isAutoTranslating) {
            clickAllButtons(TRANSLATE_TEXTS);
        }
    }, 2000);

})();
